---
title: "Code Appendix - Childhood Asthma Management Program Project - BSTA 519"
author: "Matthew Hoctor, Bryon Langford"
date: "11/30/2021"
output:
  html_document:
    number_sections: no
    theme: lumen
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(readxl)
library(tidyverse)
library(ggplot2)
library(psych)
# library(CarletonStats)
# library(pwr)
# library(BSDA)
# library(exact2x2)
# library(car)
# library(dvmisc)
# library(emmeans)
# library(gridExtra)
# library(DescTools)
# library(DiagrammeR)
library(nlme)
library(doBy)
library(multcomp)
library(mgcv)
# library(geepack)
# library(rje)
```

# CAMP dataset

Import the CAMP dataset:

```{r}
camp <- read_excel("camp_2021 class project.xlsx")
```

Fill missing covariate values:

```{r}
camp <- fill(camp, c("Anypet", "Woodstove", "Dehumid", "Parent_smokes", "FFratio"), .direction = "downup")
```

Relevel Treatment groups:

```{r}
camp$Trtment[camp$Trtment == "A"] <- "2budesonide"
camp$Trtment[camp$Trtment == "B"] <- "1nedocromil"
camp$Trtment[camp$Trtment == "C"] <- "0placebo"
```

Factor gender variable, and factor and re-level ethnicity variable:

```{r}
camp$Gender <- factor(camp$Gender)
camp$Ethnic <- factor(camp$Ethnic)
camp$Ethnic <- relevel(camp$Ethnic, ref = "w")
```

Relevel environmental variables (pet, woodstove, and parental smoking) such that 0="no" and 1="yes":

```{r}
camp$Anypet[camp$Anypet == 2] <- 0
camp$Woodstove[camp$Woodstove == 2] <- 0
camp$Parent_smokes[camp$Parent_smokes == 2] <- 0
```

Relevel dehumidifier variable:

```{r}
camp$Dehumid[camp$Dehumid == 2] <- 0
```

Convert Dehumidifier variable to factor:

```{r}
camp$Dehumid <- factor(camp$Dehumid)
```

# Descriptive Statistics

```{r}
# convert Visitc to numeric variable
# camp$Visitc <- as.numeric(camp$Visitc)  #not needed for subsequent code

summary(camp$FFratio) # FFratio variable has 31 missing values
# Remove missing values
# camp <- na.omit(camp)
# Filled missing FFratio values fixed this
```

```{r}
table(camp$Ethnic)
```

```{r}
table(camp$Dehumid)
```


# Time Plot

```{r}
camp_mean <- camp %>%
  # na.omit() %>%       #Moved na.omit to the plotting section
  group_by(Trtment, Visitc) %>%
  summarise(Mean_FFratio = mean(FFratio))

camp_mean

ggplot(data = camp_mean,
       mapping = aes(x = Visitc, y = Mean_FFratio,
                     colour = factor(Trtment), group = factor(Trtment))) +
  geom_line() + geom_point() + theme(legend.position = "right") +
  labs(y = "Mean FFratio (%)", x = "Follow-up Visit (months)") +
  scale_color_manual(labels = c("Budesonide", "Nedocromil", "Placebo"), values =   c("#009E73", "#0072B2", "#CC79A7")) + 
  ggtitle("Plot of Mean Response Profiles of FFRatio by Treatment") + 
  labs(color = "Treatments")
```

# Model Building

Full RIRS Model:

$$Y_{ij} = (\beta_0 + b_{1i}) + \beta_1 \mbox{Group}_{ij} + (\beta_2 + b_{2i} + \beta_{12}\mbox{Group}_{ij})t_{ij} +\beta_3 \mbox{Gender}_i +\beta_4 \mbox{Ethnicity}_i +\beta_5 \mbox{Pet}_i +\beta_6 \mbox{Woodstove}_i +\beta_7 \mbox{Dehumidifier}_i +\varepsilon_{ij}$$


```{r}
camp.RIRS <- lme(FFratio ~ Trtment*Fyears + Age_rz + Gender + Ethnic + Anypet + Woodstove + Dehumid + Parent_smokes,
                   data = camp,
                   random = ~1+Fyears|id,
                   method = "REML",
                   na.action = na.omit
                   )
summary(camp.RIRS)
```

