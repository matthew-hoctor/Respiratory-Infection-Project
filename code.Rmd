---
title: "Code Appendix - Childhood Asthma Management Program Project - BSTA 519"
author: "Matthew Hoctor, Bryon Langford"
date: "11/30/2021"
output:
  html_document:
    number_sections: no
    theme: lumen
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(readxl)
library(tidyverse)
library(ggplot2)
library(psych)
# library(CarletonStats)
# library(pwr)
# library(BSDA)
# library(exact2x2)
# library(car)
# library(dvmisc)
# library(emmeans)
# library(gridExtra)
# library(DescTools)
# library(DiagrammeR)
library(nlme)
library(lme4)
library(doBy)
library(multcomp)
library(mgcv)
# library(geepack)
# library(rje)
library(gtsummary)
# library(parameters)
```

# CAMP dataset

## Data import

Import the CAMP dataset:

```{r}
camp <- read_excel("camp_2021 class project.xlsx")
```

## Filling missing values

Fill missing covariate values and baseline:

```{r}
camp <- fill(camp, c("Anypet", "Woodstove", "Dehumid", "Parent_smokes", "FFratio"), .direction = "downup")
```

## Factoring & re-leveling

Relevel Treatment groups:

```{r}
camp$Trtment[camp$Trtment == "A"] <- "2budesonide"
camp$Trtment[camp$Trtment == "B"] <- "1nedocromil"
camp$Trtment[camp$Trtment == "C"] <- "0placebo"
```

Factor gender variable, and factor and re-level ethnicity variable:

```{r}
camp$Gender <- factor(camp$Gender)
camp$Ethnic <- factor(camp$Ethnic)
camp$Ethnic <- relevel(camp$Ethnic, ref = "w")
```

Relevel environmental variables (pet, woodstove, and parental smoking) such that 0="no" and 1="yes":

```{r}
camp$Anypet[camp$Anypet == 2] <- 0
camp$Woodstove[camp$Woodstove == 2] <- 0
camp$Parent_smokes[camp$Parent_smokes == 2] <- 0
```

Relevel dehumidifier variable:

```{r}
camp$Dehumid[camp$Dehumid == 2] <- 0
```

Convert Dehumidifier variable to factor:

```{r}
# camp$Dehumid <- factor(camp$Dehumid)
```

Convert visit month variable to numeric:

```{r}
camp$Visitc <- as.numeric(camp$Visitc)
```

## Creating variables for baseline values

Adding baseline values of FFratio and environmental exposures dataset; NA values will be filled:

```{r}
for (i in 1:length(camp$id)) {
  camp$BFFratio[i] <- ifelse(camp$Visitc[i] == 0, camp$FFratio[i], NA)
  camp$BAnypet[i] <- ifelse(camp$Visitc[i] == 0, camp$Anypet[i], NA)
  camp$BWoodstove[i] <- ifelse(camp$Visitc[i] == 0, camp$Woodstove[i], NA)
  camp$BDehumid[i] <- ifelse(camp$Visitc[i] == 0, camp$Dehumid[i], NA)
  camp$BParent_smokes[i] <- ifelse(camp$Visitc[i] == 0, camp$Parent_smokes[i], NA)
}
```

Filling in baseline values for subsequent data points:

```{r}
camp <- fill(camp, c("BFFratio", "BAnypet", "BWoodstove", "BDehumid", "BParent_smokes"), .direction = "down")
```

## Wide dataset

Create wide dataset with baseline FFratio variable:

```{r}
campW <- pivot_wider(
  camp, 
  id_cols = c(id, Trtment, Age_rz, Gender, Ethnic, BAnypet, BWoodstove, BDehumid, BParent_smokes, BFFratio),
  names_from = Visitc, 
  names_prefix = "m",
  values_from = FFratio)
```

## Baseline-Adjusted Long Dataset

```{r}
camp2 <- subset(camp,Visitc != 0)
```

# Descriptive Statistics

```{r}
summary(camp$FFratio) 

# Filled missing FFratio values fixed this:

# FFratio variable has 31 missing values
# Remove missing values
# camp <- na.omit(camp)
```

```{r}
table(camp$Ethnic)
```

```{r}
table(camp$Dehumid)
```

# Baseline statistics

Modify campW variables for a better table:

```{r}
campW$BDehumid[campW$BDehumid == 3] <- NA

campW$GenderF[campW$Gender == "f"] <- 1
campW$GenderF[campW$Gender == "m"] <- 0

campW$Ethnic2[campW$Ethnic == "w"] <- "White"
campW$Ethnic2[campW$Ethnic == "b"] <- "Black"
campW$Ethnic2[campW$Ethnic == "h"] <- "Hispanic"
campW$Ethnic2[campW$Ethnic == "o"] <- "Other"

campW$Age_rz <- as.numeric(campW$Age_rz)

campW$Trtment[campW$Trtment == "1nedocromil"] <- "Nedocromil"
campW$Trtment[campW$Trtment == "0placebo"] <- "Placebo"
campW$Trtment[campW$Trtment == "2budesonide"] <- "Budesonide"
```

Create factored and re-leveled ethnicity variable

```{r}
campW$Ethnic2 <- factor(campW$Ethnic2)
campW$Ethnic2 <- relevel(campW$Ethnic2, ref = "White")
```

Try adding a random value to age to get it to display as an average:

```{r}
for (i in 1:length(campW)) {
  campW$Age_rz2[i] <- campW$Age_rz[i] +rnorm(1)/1000000
  campW$BFFratio2[i] <- campW$BFFratio[i] +rnorm(1)/1000000
}
```


```{r}
campW %>% 
  select(Trtment, BFFratio2, Age_rz2, GenderF, Ethnic2, BAnypet, BWoodstove, BDehumid, BParent_smokes) %>%
  tbl_summary(
  by = Trtment,
  missing = "no",
  digits = list(
    Age_rz2 ~ 2,
    BFFratio2 ~ 2
  ),
  label = list(
    BFFratio2 ~ "FEV1/FVC Ratio",
    Age_rz2 ~ "Age",
    GenderF ~ "Female Gender",
    Ethnic2 ~ "Ethnicity",
    BAnypet ~ "Pet Exposure",
    BWoodstove ~ "Woodstove Exposure",
    BDehumid ~ "Dehumidifier Exposure",
    BParent_smokes ~ "Tobacco Smoke Exposure"
  ),
    statistic = list(
      all_continuous() ~ "{mean}",
      all_categorical() ~ "{n} ({p}%)"),
  ) %>% 
  add_p()%>%
  modify_caption("**Table 1. Baseline Patient Characteristics**") %>%
  bold_labels()
```


# Time Plot

```{r}
camp_mean <- camp %>%
  # na.omit() %>%       #Moved na.omit to the plotting section
  group_by(Trtment, Visitc) %>%
  summarise(Mean_FFratio = mean(FFratio))

camp_mean

ggplot(data = camp_mean,
       mapping = aes(x = Visitc, y = Mean_FFratio,
                     colour = factor(Trtment), group = factor(Trtment))) +
  geom_line() + geom_point() + theme(legend.position = "right") +
  labs(y = "Mean FFratio (%)", x = "Follow-up Visit (months)") +
  scale_color_manual(labels = c("Budesonide", "Nedocromil", "Placebo"), values =   c("#009E73", "#0072B2", "#CC79A7")) + 
  ggtitle("Plot of Mean Response Profiles of FFRatio by Treatment") + 
  labs(color = "Treatments")
```

# Model Building

## Effectiveness of budesonide vs nedocromil

### RIRS Model

$$Y_{ij} = (\beta_0 + b_{1i}) + \beta_1 \mbox{Nedocromil}_{i} + \beta_2 \mbox{Budesonide}_{i} + (\beta_3 + b_{2i} + \beta_{11} \mbox{Nedocromil}_{i} + \beta_{12} \mbox{Budesonide}_{i})t_{ij}  +\varepsilon_{ij}$$

```{r}
camp.RIRS.reduced <- lme(FFratio ~ Trtment*Fyears,
                   data = camp,
                   random = ~1+Fyears|id,
                   method = "REML",
                   na.action = na.omit
                   )
summary(camp.RIRS.reduced)
```

### RI Model

$$Y_{ij} = (\beta_0 + b_{1i}) + \beta_1 \mbox{Nedocromil}_{i} + \beta_2 \mbox{Budesonide}_{i} + (\beta_3 + \beta_{11} \mbox{Nedocromil}_{i} + \beta_{12} \mbox{Budesonide}_{i})t_{ij}  +\varepsilon_{ij}$$

```{r}
camp.RI.reduced <- lme(FFratio ~ Trtment*Fyears,
                   data = camp,
                   random = ~1|id,
                   method = "REML",
                   na.action = na.omit
                   )
summary(camp.RI.reduced)
```

Comparison to RIRS model:

```{r}
anova(camp.RI.reduced, camp.RIRS.reduced)
```

From Fitzmaurice Table C1, for $q = 10$, a critical value of 32.40 corresponds to p=0.0005; therefore the RIRS model is a better fit.

### Baseline-adjusted RIRS model

$$Y_{ij} = (\beta_0 + b_{1i}) + \beta_1 \mbox{Nedocromil}_{i} + \beta_2 \mbox{Budesonide}_{i} + (\beta_3 + b_{2i} + \beta_{11} \mbox{Nedocromil}_{i} + \beta_{12} \mbox{Budesonide}_{i})t_{ij} + \beta_4 \mbox{Base-FFratio}_i +\varepsilon_{ij}$$

```{r}
camp2.RIRS.reduced <- lme(FFratio ~ Trtment*Fyears + BFFratio,
                   data = camp2,
                   random = ~1+Fyears|id,
                   method = "REML",
                   na.action = na.omit
                   )
summary(camp2.RIRS.reduced)
```

### baseline-adjusted RI Model

$$Y_{ij} = (\beta_0 + b_{1i}) + \beta_1 \mbox{Nedocromil}_{i} + \beta_2 \mbox{Budesonide}_{i} + (\beta_3 + \beta_{11} \mbox{Nedocromil}_{i} + \beta_{12} \mbox{Budesonide}_{i})t_{ij} + \beta_4 \mbox{Base-FFratio}_i +\varepsilon_{ij}$$

```{r}
camp2.RI.reduced <- lme(FFratio ~ Trtment*Fyears + BFFratio,
                   data = camp2,
                   random = ~1|id,
                   method = "REML",
                   na.action = na.omit
                   )
summary(camp2.RI.reduced)
```

Comparison to RIRS model:

```{r}
anova(camp2.RI.reduced, camp2.RIRS.reduced)
anova(camp.RI.reduced, camp.RIRS.reduced)
```

From Fitzmaurice Table C1, for $q = 10$, a critical value of 32.40 corresponds to p=0.0005; therefore the baseline-adjusted RIRS model is a better fit.  The baseline-adjusted and unadjusted models cannot be directly compared; however the baseline adjusted models have lesser AIC & BIC values, greater biological plausibility (espeially for budesonide), 

### Change over time in FF ratio

Starting with the baseline-adjusted RIRS model; we can test $H_0: \beta_3 = 0$:

```{r}
B3 = c(0,0,0,1,0,0,0)
anova(camp2.RIRS.reduced, L = B3)
```

Therefore we can conclude that there is a change over time in FF ratio

### Effectiveness of budesonide and nedocromil in preventing decline of FFratio

We can first start with the null hypothesis that neither treatment is effective; $H_0: \beta_{11} = \beta_{12} = 0$:

```{r}
B11 = c(0,0,0,0,0,1,0)
B12 = c(0,0,0,0,0,0,1)
anova(camp2.RIRS.reduced, L = rbind(B11, B12))
```

We can now test each individually:

```{r}
anova(camp2.RIRS.reduced, L = B11)
anova(camp2.RIRS.reduced, L = B12)
```

Therefore nedocromil does not significantly prevent decline of FFratio, but budesonide does have a statistically significant effect on decline in FFratio

### Difference in effectiveness of budesonide vs nedocromil

To test differences in effectiveness of budesonide vs nedocromil we can test differences in immediate effect and effect over time; to test if there is a difference in immediate effect we will test $H_0: \beta_1 - \beta_2 = 0$:

```{r}
B1B2 = c(0,1,-1,0,0,0,0)
anova(camp2.RIRS.reduced, L = B1B2)
```

We find a significant difference in immediate effect.  To test effect over time, we can test $H_0: \beta_{11} - \beta_{12} = 0$:

```{r}
B11B12 = c(0,0,0,0,0,1,-1)
anova(camp2.RIRS.reduced, L = B11B12)
```

We also find a significant difference in effect over time.

## Patient characteristics-adjusted associations with FFratio

$$Y_{ij} = (\beta_0 + b_{1i}) + \beta_1 \mbox{Nedocromil}_{i} + \beta_2 \mbox{Budesonide}_{i} + (\beta_3 + b_{2i} + \beta_{11} \mbox{Nedocromil}_{i} + \beta_{12} \mbox{Budesonide}_{i})t_{ij} +\beta_4 \mbox{Gender}_i +\beta_5 \mbox{Ethnicity}_i +\beta_6 \mbox{Pet}_i +\beta_7 \mbox{Woodstove}_i +\beta_8 \mbox{Dehumidifier}_i + \beta_9 \mbox{Base-FFratio}_i  +\varepsilon_{ij}$$


```{r}
camp2.RIRS.full <- lme(FFratio ~ Trtment*Fyears + Age_rz + Gender + Ethnic + Anypet + Woodstove + Dehumid + Parent_smokes + BFFratio,
                   data = camp2,
                   random = ~1+Fyears|id,
                   method = "REML",
                   na.action = na.omit
                   )
summary(camp2.RIRS.full)
```

It is interesting to note that treatment effects seem to have similar values in the full model.

### Deletion 1

Given the above results, we can consider removing age from the above model:

```{r}
camp2.RIRS.1 <- lme(FFratio ~ Trtment*Fyears + Gender + Ethnic + Anypet + Woodstove + Dehumid + Parent_smokes + BFFratio,
                   data = camp2,
                   random = ~1+Fyears|id,
                   method = "REML",
                   na.action = na.omit
                   )
summary(camp2.RIRS.1)
```

We can compare the fit of the reduced model

```{r}
anova(camp2.RIRS.full, camp2.RIRS.1)
```

The models have similar fit; therefore we can proceed with the next deletion step.

### Deletion 2

Given the above results, we can consider removing age from the above model:

```{r}
camp2.RIRS.2 <- lme(FFratio ~ Trtment*Fyears + Ethnic + Anypet + Woodstove + Dehumid + Parent_smokes + BFFratio,
                   data = camp2,
                   random = ~1+Fyears|id,
                   method = "REML",
                   na.action = na.omit
                   )
summary(camp2.RIRS.2)
```

We can compare the fit of the reduced model

```{r}
anova(camp2.RIRS.1, camp2.RIRS.2)
```

The models have similar fit; therefore we can proceed with the next deletion step.

### Deletion 3

Given the above results, we can consider removing dehumidifier exposure from the above model:

```{r}
camp2.RIRS.3 <- lme(FFratio ~ Trtment*Fyears + Ethnic + Anypet + Woodstove + Parent_smokes + BFFratio,
                   data = camp2,
                   random = ~1+Fyears|id,
                   method = "REML",
                   na.action = na.omit
                   )
summary(camp2.RIRS.3)
```

We can compare the fit of the reduced model

```{r}
anova(camp2.RIRS.2, camp2.RIRS.3)
```

The models have similar fit; therefore we can proceed with the next deletion step.

### Deletion 4

Given the above results, we can consider removing secondhand smoke exposure from the above model:

```{r}
camp2.RIRS.4 <- lme(FFratio ~ Trtment*Fyears + Ethnic + Anypet + Woodstove + BFFratio,
                   data = camp2,
                   random = ~1+Fyears|id,
                   method = "REML",
                   na.action = na.omit
                   )
summary(camp2.RIRS.4)
```

We can compare the fit of the reduced model

```{r}
anova(camp2.RIRS.3, camp2.RIRS.4)
```

The models have similar fit; therefore we can proceed with the next deletion step.

### Deletion 5

Given the above results, we can consider removing woodstove exposure from the above model:

```{r}
camp2.RIRS.5 <- lme(FFratio ~ Trtment*Fyears + Ethnic + Anypet + BFFratio,
                   data = camp2,
                   random = ~1+Fyears|id,
                   method = "REML",
                   na.action = na.omit
                   )
summary(camp2.RIRS.5)
```

We can compare the fit of the reduced model

```{r}
anova(camp2.RIRS.4, camp2.RIRS.5)
```

The models have similar fit; therefore we can proceed with the next deletion step.

### Deletion 6

Given the above results, we can consider removing ethnicity from the above model:

```{r}
camp2.RIRS.6 <- lme(FFratio ~ Trtment*Fyears + Anypet + BFFratio,
                   data = camp2,
                   random = ~1+Fyears|id,
                   method = "REML",
                   na.action = na.omit
                   )
summary(camp2.RIRS.6)
```

We can compare the fit of the reduced model

```{r}
anova(camp2.RIRS.5, camp2.RIRS.6)
```

The models have similar fit; therefore we can proceed with the next deletion step.

### Deletion 7

Given the above results, we can consider removing pet exposure from the above model:

```{r}
camp2.RIRS.7 <- lme(FFratio ~ Trtment*Fyears + BFFratio,
                   data = camp2,
                   random = ~1+Fyears|id,
                   method = "REML",
                   na.action = na.omit
                   )
summary(camp2.RIRS.7)
```

We can compare the fit of the reduced model

```{r}
anova(camp2.RIRS.6, camp2.RIRS.7)
```

The models have similar fit; therefore we can proceed with the next deletion step.

### Deletion 8

Given the above results, we can consider removing pet exposure from the above model:

```{r}
camp2.RIRS.8 <- lme(FFratio ~ Trtment*Fyears,
                   data = camp2,
                   random = ~1+Fyears|id,
                   method = "REML",
                   na.action = na.omit
                   )
summary(camp2.RIRS.8)
```

We can compare the fit of the reduced model

```{r}
anova(camp2.RIRS.7, camp2.RIRS.8)
```

The models do not have similar fit; therefore model 7 is the parsimonious model.

## Model Tables

### Full baseline-adjusted RIRS Model

Create a display-friendly dataset from the camp2 dataset:

```{r}
camp3 <- camp2
```

Create display-friendly gender variable:

```{r}
camp3$GenderF[camp3$Gender == "f"] <- 1
camp3$GenderF[camp3$Gender == "m"] <- 0
```

Update ethnicity variable for display:

```{r}
camp3$Ethnic2[camp3$Ethnic == "w"] <- "White"
camp3$Ethnic2[camp3$Ethnic == "b"] <- "Black"
camp3$Ethnic2[camp3$Ethnic == "h"] <- "Hispanic"
camp3$Ethnic2[camp3$Ethnic == "o"] <- "Other"

# Create factored and releveled display ethnicity variable:
camp3$Ethnic2 <- factor(camp3$Ethnic2)
camp3$Ethnic2 <- relevel(camp3$Ethnic2, ref = "White")
```

Update treatment variable for display:

```{r}
camp3$Trtment2[camp3$Trtment == "0placebo"] <- "Placebo"
camp3$Trtment2[camp3$Trtment == "1nedocromil"] <- "Nedocromil"
camp3$Trtment2[camp3$Trtment == "2budesonide"] <- "Budesonide"

# Create factored and releveled display treatment variable:
camp3$Trtment2 <- factor(camp3$Trtment2)
camp3$Trtment2 <- relevel(camp3$Trtment2, ref = "Placebo")

```


Create the model with lme4:

```{r}
camp3.RIRS.full <- lmer(
  FFratio ~ Trtment2*Fyears + BFFratio + Age_rz + GenderF + Ethnic2 + Anypet + Woodstove + Dehumid + Parent_smokes + (1+Fyears|id),
  data = camp3,
  REML = TRUE,
  na.action = na.omit
  )
summary(camp3.RIRS.full)
```


```{r}
(T2 <- tbl_regression(camp3.RIRS.full,
               label = list(
                 BFFratio ~ "Baseline FEV1/FVC Ratio",
                 Trtment2 ~ "Treatment",
                 Fyears ~ "Time (Years)",
                 Age_rz ~ "Baseline Age",
                 Ethnic2 ~ "Ethnicity",
                 GenderF ~ "Female Gender",
                 Anypet ~ "Pet Exposure",
                 Woodstove ~ "Woodstove Exposure",
                 Dehumid ~ "Dehumidifier Exposure"
               ),
               tidy_fun = broom.mixed::tidy
               ) %>%
  modify_caption("**Table 2. Full Model Parameters**") %>%
  bold_labels())
```


### Parsimonious baseline-adjusted RIRS model



# Model Diagnostics
