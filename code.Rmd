---
title: "Code Appendix - Childhood Asthma Management Program Project - BSTA 519"
author: "Matthew Hoctor, Bryon Langford"
date: "11/30/2021"
output:
  html_document:
    number_sections: no
    theme: lumen
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(readxl)
library(tidyverse)
library(ggplot2)
library(psych)
# library(CarletonStats)
# library(pwr)
# library(BSDA)
# library(exact2x2)
# library(car)
# library(dvmisc)
# library(emmeans)
# library(gridExtra)
# library(DescTools)
# library(DiagrammeR)
library(nlme)
library(doBy)
library(multcomp)
library(mgcv)
# library(geepack)
# library(rje)
library(gtsummary)
```

# CAMP dataset

## Data import

Import the CAMP dataset:

```{r}
camp <- read_excel("camp_2021 class project.xlsx")
```

## Filling missing values

Fill missing covariate values and baseline:

```{r}
camp <- fill(camp, c("Anypet", "Woodstove", "Dehumid", "Parent_smokes", "FFratio"), .direction = "downup")
```

## Factoring & re-leveling

Relevel Treatment groups:

```{r}
camp$Trtment[camp$Trtment == "A"] <- "2budesonide"
camp$Trtment[camp$Trtment == "B"] <- "1nedocromil"
camp$Trtment[camp$Trtment == "C"] <- "0placebo"
```

Factor gender variable, and factor and re-level ethnicity variable:

```{r}
camp$Gender <- factor(camp$Gender)
camp$Ethnic <- factor(camp$Ethnic)
camp$Ethnic <- relevel(camp$Ethnic, ref = "w")
```

Relevel environmental variables (pet, woodstove, and parental smoking) such that 0="no" and 1="yes":

```{r}
camp$Anypet[camp$Anypet == 2] <- 0
camp$Woodstove[camp$Woodstove == 2] <- 0
camp$Parent_smokes[camp$Parent_smokes == 2] <- 0
```

Relevel dehumidifier variable:

```{r}
camp$Dehumid[camp$Dehumid == 2] <- 0
```

Convert Dehumidifier variable to factor:

```{r}
# camp$Dehumid <- factor(camp$Dehumid)
```

Convert visit month variable to numeric:

```{r}
camp$Visitc <- as.numeric(camp$Visitc)
```

## Creating variables for baseline values

Adding baseline values of FFratio and environmental exposures dataset; NA values will be filled:

```{r}
for (i in 1:length(camp$id)) {
  camp$BFFratio[i] <- ifelse(camp$Visitc[i] == 0, camp$FFratio[i], NA)
  camp$BAnypet[i] <- ifelse(camp$Visitc[i] == 0, camp$Anypet[i], NA)
  camp$BWoodstove[i] <- ifelse(camp$Visitc[i] == 0, camp$Woodstove[i], NA)
  camp$BDehumid[i] <- ifelse(camp$Visitc[i] == 0, camp$Dehumid[i], NA)
  camp$BParent_smokes[i] <- ifelse(camp$Visitc[i] == 0, camp$Parent_smokes[i], NA)
}
```

Filling in baseline values for subsequent data points:

```{r}
camp <- fill(camp, c("BFFratio", "BAnypet", "BWoodstove", "BDehumid", "BParent_smokes"), .direction = "down")
```

## Wide dataset

Create wide dataset with baseline FFratio variable:

```{r}
campW <- pivot_wider(
  camp, 
  id_cols = c(id, Trtment, Age_rz, Gender, Ethnic, BAnypet, BWoodstove, BDehumid, BParent_smokes),
  names_from = Visitc, 
  names_prefix = "m",
  values_from = FFratio)
```

# Descriptive Statistics

```{r}
summary(camp$FFratio) 

# Filled missing FFratio values fixed this:

# FFratio variable has 31 missing values
# Remove missing values
# camp <- na.omit(camp)
```

```{r}
table(camp$Ethnic)
```

```{r}
table(camp$Dehumid)
```

# Baseline statistics:

Modify campW variables for a better table:

```{r}
campW$BDehumid[campW$BDehumid == 3] <- NA

campW$GenderF[campW$Gender == "f"] <- 1
campW$GenderF[campW$Gender == "m"] <- 0

campW$Ethnic2[campW$Ethnic == "w"] <- "White"
campW$Ethnic2[campW$Ethnic == "b"] <- "Black"
campW$Ethnic2[campW$Ethnic == "h"] <- "Hispanic"
campW$Ethnic2[campW$Ethnic == "o"] <- "Other"

campW$Age_rz <- as.numeric(campW$Age_rz)

campW$Trtment[campW$Trtment == "1nedocromil"] <- "Nedocromil"
campW$Trtment[campW$Trtment == "0placebo"] <- "Placebo"
campW$Trtment[campW$Trtment == "2budesonide"] <- "Budesonide"
```

Create factored and re-leveled ethnicity variable

```{r}
campW$Ethnic2 <- factor(campW$Ethnic2)
campW$Ethnic2 <- relevel(campW$Ethnic2, ref = "White")
```

Try adding a random value to age to get it to display as an average:

```{r}
for (i in 1:length(campW)) {
  campW$Age_rz2[i] <- campW$Age_rz[i] +rnorm(1)/1000000
}
```


```{r}
campW %>% 
  select(Trtment, Age_rz2, GenderF, Ethnic2, BAnypet, BWoodstove, BDehumid, BParent_smokes) %>%
  tbl_summary(
  by = Trtment,
  missing = "no",
  label = list(
    Age_rz2 ~ "Age",
    GenderF ~ "Female Gender",
    Ethnic2 ~ "Ethnicity",
    BAnypet ~ "Pet Exposure",
    BWoodstove ~ "Woodstove Exposure",
    BDehumid ~ "Dehumidifier Exposure",
    BParent_smokes ~ "Tobacco Smoke Exposure"
  ),
    statistic = list(
      all_continuous() ~ "{mean}",
      all_categorical() ~ "{n} ({p}%)"),
  ) %>% 
  add_p()%>%
  modify_caption("**Table 1. Patient Characteristics**") %>%
  bold_labels()
```


# Time Plot

```{r}
camp_mean <- camp %>%
  # na.omit() %>%       #Moved na.omit to the plotting section
  group_by(Trtment, Visitc) %>%
  summarise(Mean_FFratio = mean(FFratio))

camp_mean

ggplot(data = camp_mean,
       mapping = aes(x = Visitc, y = Mean_FFratio,
                     colour = factor(Trtment), group = factor(Trtment))) +
  geom_line() + geom_point() + theme(legend.position = "right") +
  labs(y = "Mean FFratio (%)", x = "Follow-up Visit (months)") +
  scale_color_manual(labels = c("Budesonide", "Nedocromil", "Placebo"), values =   c("#009E73", "#0072B2", "#CC79A7")) + 
  ggtitle("Plot of Mean Response Profiles of FFRatio by Treatment") + 
  labs(color = "Treatments")
```

# Model Building

Full RIRS Model:

$$Y_{ij} = (\beta_0 + b_{1i}) + \beta_1 \mbox{Group}_{ij} + (\beta_2 + b_{2i} + \beta_{12}\mbox{Group}_{ij})t_{ij} +\beta_3 \mbox{Gender}_i +\beta_4 \mbox{Ethnicity}_i +\beta_5 \mbox{Pet}_i +\beta_6 \mbox{Woodstove}_i +\beta_7 \mbox{Dehumidifier}_i +\varepsilon_{ij}$$


```{r}
camp.RIRS <- lme(FFratio ~ Trtment*Fyears + Age_rz + Gender + Ethnic + Anypet + Woodstove + Dehumid + Parent_smokes,
                   data = camp,
                   random = ~1+Fyears|id,
                   method = "REML",
                   na.action = na.omit
                   )
summary(camp.RIRS)
```

